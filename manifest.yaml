apiVersion: v1
kind: Pod
metadata:
  name: radfm
  namespace: kkannan1
spec:
      nodeName: rkegpu03
      volumes:
        - name: shared-memory-patch
          emptyDir:
            medium: Memory
        - name: imaging-data
          hostPath:
            path: /mnt/ai_s3_synced/imaging
            type: Directory
        - name: teamblackhole
          hostPath:
            path: /mnt/team_blackhole
            type: Directory
        - name: teams3synced
          hostPath:
            path: /mnt/team_s3_synced
            type: Directory
  # template:
  #   spec:
      # nodeName: rkegpu02
      containers:
      - name: radfm
        imagePullPolicy: Always
        # image: coverahealth.jfrog.io/ai-development-docker/kawshik/llava:noflash
        image: coverahealth.jfrog.io/ai-development-docker/kawshik/radfm_train:latest
        command: ["python", "train.py",
                  "--output_dir", "/mnt/team_blackhole/kawshik/radfm_ckpts",
                  "--bf16","True",
                  "--num_train_epochs","25",
                  "--batch_size_3D","1",
                  "--batch_size_2D","1",
                  # "--per_device_train_batch_size","8",
                  "--gradient_accumulation_steps","128",
                  # "--per_device_eval_batch_size","8",
                  "--eval_accumulation_steps","128",
                  # "--tf32","True", 
                  "--evaluation_strategy","steps", 
                  "--eval_steps","100", 
                  "--metric_for_best_model","eval_rouge2",
                  "--save_strategy","steps",
                  "--save_steps","100",
                  "--save_total_limit","4",
                  "--learning_rate","7e-5", 
                  # "--learning_rate","2e-3", 
                  "--weight_decay","0.",
                  # "--optim","adafactor",
                  "--warmup_ratio","0.03", 
                  "--lr_scheduler_type","cosine",
                  "--logging_steps","1", 
                  # "--model_max_length","512",
                  # "--gradient_checkpointing","True", 
                  "--dataloader_num_workers","3", 
                  # "--lazy_preprocess","True",
                  "--report_to","wandb", 
                  # "--val_steps","10000",
                  ]
        
        volumeMounts:
        - name: shared-memory-patch
          mountPath: /dev/shm
        - name: imaging-data
          mountPath: /mnt/imaging
        - name: teamblackhole
          mountPath: /mnt/team_blackhole
        - name: teams3synced
          mountPath: /mnt/team_s3_synced

        resources:
          limits:
            # memory: "480000Mi"
            nvidia.com/gpu: "1"
          requests:
            # memory: "409600Mi"
            nvidia.com/gpu: "1"
      # imagePullSecrets:
      #   - name: ecr-cred
      # restartPolicy: Never
  # backoffLimit: 0